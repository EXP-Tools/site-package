function html_format(){var t=$.trim($("#tool-form").val());if(""==t)return tips_error("请填写需要格式的HTML代码！"),$("#tool-form").focus(),!1;var e=$("#tabsize").val();tabchar=" ",1==e&&(tabchar="\t");var i=style_html(t,e,tabchar,80);$("#tool-result").val(i),tips_clear()}function style_html(t,e,i,n){var s;for((s=new function(){return this.pos=0,this.token="",this.current_mode="CONTENT",this.tags={parent:"parent1",parentcount:1,parent1:""},this.tag_type="",this.token_text=this.last_token=this.last_text=this.token_type="",this.Utils={whitespace:"\n\r\t ".split(""),single_token:"br,input,link,meta,!doctype,basefont,base,area,hr,wbr,param,img,isindex,?xml,embed".split(","),extra_liners:"head,body,/html".split(","),in_array:function(t,e){for(var i=0;i<e.length;i++)if(t===e[i])return!0;return!1}},this.get_content=function(){for(var t="",e=[],i=!1;"<"!==this.input.charAt(this.pos);){if(this.pos>=this.input.length)return e.length?e.join(""):["","TK_EOF"];if(t=this.input.charAt(this.pos),this.pos++,this.line_char_count++,this.Utils.in_array(t,this.Utils.whitespace))e.length&&(i=!0),this.line_char_count--;else{if(i){if(this.line_char_count>=this.max_char){e.push("\n");for(var n=0;n<this.indent_level;n++)e.push(this.indent_string);this.line_char_count=0}else e.push(" "),this.line_char_count++;i=!1}e.push(t)}}return e.length?e.join(""):""},this.get_script=function(){var t="",e=[],i=new RegExp("<\/script>","igm");i.lastIndex=this.pos;for(var n=i.exec(this.input),s=n?n.index:this.input.length;this.pos<s;){if(this.pos>=this.input.length)return e.length?e.join(""):["","TK_EOF"];t=this.input.charAt(this.pos),this.pos++,e.push(t)}return e.length?e.join(""):""},this.record_tag=function(t){this.tags[t+"count"]?this.tags[t+"count"]++:this.tags[t+"count"]=1,this.tags[t+this.tags[t+"count"]]=this.indent_level,this.tags[t+this.tags[t+"count"]+"parent"]=this.tags.parent,this.tags.parent=t+this.tags[t+"count"]},this.retrieve_tag=function(t){if(this.tags[t+"count"]){for(var e=this.tags.parent;e&&t+this.tags[t+"count"]!==e;)e=this.tags[e+"parent"];e&&(this.indent_level=this.tags[t+this.tags[t+"count"]],this.tags.parent=this.tags[e+"parent"]),delete this.tags[t+this.tags[t+"count"]+"parent"],delete this.tags[t+this.tags[t+"count"]],1==this.tags[t+"count"]?delete this.tags[t+"count"]:this.tags[t+"count"]--}},this.get_tag=function(){var t="",e=[],i=!1;do{if(this.pos>=this.input.length)return e.length?e.join(""):["","TK_EOF"];t=this.input.charAt(this.pos),this.pos++,this.line_char_count++,this.Utils.in_array(t,this.Utils.whitespace)?(i=!0,this.line_char_count--):("'"!==t&&'"'!==t||e[1]&&"!"===e[1]||(t+=this.get_unformatted(t),i=!0),"="===t&&(i=!1),e.length&&"="!==e[e.length-1]&&">"!==t&&i&&(this.line_char_count>=this.max_char?(this.print_newline(!1,e),this.line_char_count=0):(e.push(" "),this.line_char_count++),i=!1),e.push(t))}while(">"!==t);var n,s=e.join("");n=-1!=s.indexOf(" ")?s.indexOf(" "):s.indexOf(">");var r=s.substring(1,n).toLowerCase();if("/"===s.charAt(s.length-2)||this.Utils.in_array(r,this.Utils.single_token))this.tag_type="SINGLE";else if("script"===r)this.record_tag(r),this.tag_type="SCRIPT";else if("style"===r)this.record_tag(r),this.tag_type="STYLE";else if("!"===r.charAt(0))if(-1!=r.indexOf("[if")){if(-1!=s.indexOf("!IE")){var h=this.get_unformatted("--\x3e",s);e.push(h)}this.tag_type="START"}else if(-1!=r.indexOf("[endif"))this.tag_type="END",this.unindent();else if(-1!=r.indexOf("[cdata[")){h=this.get_unformatted("]]>",s);e.push(h),this.tag_type="SINGLE"}else{h=this.get_unformatted("--\x3e",s);e.push(h),this.tag_type="SINGLE"}else"/"===r.charAt(0)?(this.retrieve_tag(r.substring(1)),this.tag_type="END"):(this.record_tag(r),this.tag_type="START"),this.Utils.in_array(r,this.Utils.extra_liners)&&this.print_newline(!0,this.output);return e.join("")},this.get_unformatted=function(t,e){if(e&&-1!=e.indexOf(t))return"";var i="",n="",s=!0;do{if(i=this.input.charAt(this.pos),this.pos++,this.Utils.in_array(i,this.Utils.whitespace)){if(!s){this.line_char_count--;continue}if("\n"===i||"\r"===i){n+="\n";for(var r=0;r<this.indent_level;r++)n+=this.indent_string;s=!1,this.line_char_count=0;continue}}n+=i,this.line_char_count++,s=!0}while(-1==n.indexOf(t));return n},this.get_token=function(){var t;if("TK_TAG_SCRIPT"!==this.last_token)return"CONTENT"===this.current_mode?"string"!=typeof(t=this.get_content())?t:[t,"TK_CONTENT"]:"TAG"===this.current_mode?"string"!=typeof(t=this.get_tag())?t:[t,"TK_TAG_"+this.tag_type]:void 0;var e=this.get_script();return"string"!=typeof e?e:[t=js_beautify(e,this.indent_size,this.indent_character,this.indent_level),"TK_CONTENT"]},this.printer=function(t,e,i,n){this.input=t||"",this.output=[],this.indent_character=e||" ",this.indent_string="",this.indent_size=i||2,this.indent_level=0,this.max_char=n||70;for(var s=this.line_char_count=0;s<this.indent_size;s++)this.indent_string+=this.indent_character;this.print_newline=function(t,e){if(this.line_char_count=0,e&&e.length){if(!t)for(;this.Utils.in_array(e[e.length-1],this.Utils.whitespace);)e.pop();e.push("\n");for(var i=0;i<this.indent_level;i++)e.push(this.indent_string)}},this.print_token=function(t){this.output.push(t)},this.indent=function(){this.indent_level++},this.unindent=function(){0<this.indent_level&&this.indent_level--}},this}).printer(t,i,e);;){var r=s.get_token();if(s.token_text=r[0],s.token_type=r[1],"TK_EOF"===s.token_type)break;switch(s.token_type){case"TK_TAG_START":case"TK_TAG_SCRIPT":case"TK_TAG_STYLE":s.print_newline(!1,s.output),s.print_token(s.token_text),s.indent(),s.current_mode="CONTENT";break;case"TK_TAG_END":s.print_newline(!0,s.output),s.print_token(s.token_text),s.current_mode="CONTENT";break;case"TK_TAG_SINGLE":s.print_newline(!1,s.output),s.print_token(s.token_text),s.current_mode="CONTENT";break;case"TK_CONTENT":""!==s.token_text&&(s.print_newline(!1,s.output),s.print_token(s.token_text)),s.current_mode="TAG"}s.last_token=s.token_type,s.last_text=s.token_text}return s.output.join("")}function js_beautify(t,e,i,n){var a,s,r,_,o,h,c,u,l,T,f,p,g,K,E,O,d,N,A,R;function v(){for(;s.length&&(" "===s[s.length-1]||s[s.length-1]===l);)s.pop()}function C(t){if(t=void 0===t||t,v(),s.length){"\n"===s[s.length-1]&&t||s.push("\n");for(var e=0;e<n;e++)s.push(l)}}function k(){var t=s.length?s[s.length-1]:" ";" "!==t&&"\n"!==t&&t!==l&&s.push(" ")}function D(){s.push(r)}function b(){n++}function L(){n&&n--}function y(t){u.push(c),c=t}function S(){N="DO_BLOCK"===c,c=u.pop()}function m(t,e){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1}function x(){var t=0,e="";do{if(g>=a.length)return["","TK_EOF"];e=a.charAt(g),g+=1,"\n"===e&&(t+=1)}while(m(e,T));if(1<t)for(var i=0;i<2;i++)C(0===i);var n=1===t;if(m(e,f)){if(g<a.length)for(;m(a.charAt(g),f)&&(e+=a.charAt(g),(g+=1)!==a.length););return g!==a.length&&e.match(/^[0-9]+[Ee]$/)&&"-"===a.charAt(g)?(g+=1,[e+="-"+x()[0],"TK_WORD"]):"in"===e?[e,"TK_OPERATOR"]:[e,"TK_WORD"]}if("("===e||"["===e)return[e,"TK_START_EXPR"];if(")"===e||"]"===e)return[e,"TK_END_EXPR"];if("{"===e)return[e,"TK_START_BLOCK"];if("}"===e)return[e,"TK_END_BLOCK"];if(";"===e)return[e,"TK_END_COMMAND"];if("/"===e){var s="";if("*"===a.charAt(g)){if((g+=1)<a.length)for(;("*"!==a.charAt(g)||!a.charAt(g+1)||"/"!==a.charAt(g+1))&&g<a.length&&(s+=a.charAt(g),!((g+=1)>=a.length)););return g+=2,["/*"+s+"*/","TK_BLOCK_COMMENT"]}if("/"===a.charAt(g)){for(s=e;"\r"!==a.charAt(g)&&"\n"!==a.charAt(g)&&(s+=a.charAt(g),!((g+=1)>=a.length)););return g+=1,n&&C(),[s,"TK_COMMENT"]}}if("'"===e||'"'===e||"/"===e&&("TK_WORD"===_&&"return"===o||"TK_START_EXPR"===_||"TK_END_BLOCK"===_||"TK_OPERATOR"===_||"TK_EOF"===_||"TK_END_COMMAND"===_)){var r=e,h=!1;if(e="",g<a.length)for(;(h||a.charAt(g)!==r)&&(e+=a.charAt(g),h=!h&&"\\"===a.charAt(g),!((g+=1)>=a.length)););return g+=1,"TK_END_COMMAND"===_&&C(),[r+e+r,"TK_STRING"]}if(m(e,p)){for(;g<a.length&&m(e+a.charAt(g),p)&&(e+=a.charAt(g),!((g+=1)>=a.length)););return[e,"TK_OPERATOR"]}return[e,"TK_UNKNOWN"]}for(i=i||" ",e=e||4,l="";e--;)l+=i;for(a=t,_="TK_START_EXPR",R=A=N=!(s=[]),T="\n\r\t ".split(o=h=""),f="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_$".split(""),p="+ - * / % & ++ -- = += -= *= /= %= == === != !== > < >= <= >> << >>> >>>= >>= <<= && &= | || ! !! , : ? ^ ^= |=".split(" "),K="continue,try,throw,return,var,if,switch,case,default,for,while,break,function".split(","),n=n||0,g=0,E=!(u=[c="BLOCK"]);;){var P=x();if(r=P[0],"TK_EOF"===(d=P[1]))break;switch(d){case"TK_START_EXPR":A=!1,y("EXPRESSION"),"TK_END_EXPR"===_||"TK_START_EXPR"===_||("TK_WORD"!==_&&"TK_OPERATOR"!==_?k():m(h,K)&&"function"!==h&&k()),D();break;case"TK_END_EXPR":D(),S();break;case"TK_START_BLOCK":y("do"===h?"DO_BLOCK":"BLOCK"),"TK_OPERATOR"!==_&&"TK_START_EXPR"!==_&&("TK_START_BLOCK"===_?C():k()),D(),b();break;case"TK_END_BLOCK":"TK_START_BLOCK"===_?(v(),L()):(L(),C()),D(),S();break;case"TK_WORD":if(N){k(),D(),k();break}if("case"===r||"default"===r){":"===o?s.length&&s[s.length-1]===l&&s.pop():(L(),C(),b()),D(),E=!0;break}O="NONE","TK_END_BLOCK"===_?m(r.toLowerCase(),["else","catch","finally"])?(O="SPACE",k()):O="NEWLINE":"TK_END_COMMAND"!==_||"BLOCK"!==c&&"DO_BLOCK"!==c?"TK_END_COMMAND"===_&&"EXPRESSION"===c?O="SPACE":"TK_WORD"===_?O="SPACE":"TK_START_BLOCK"===_?O="NEWLINE":"TK_END_EXPR"===_&&(k(),O="NEWLINE"):O="NEWLINE","TK_END_BLOCK"!==_&&m(r.toLowerCase(),["else","catch","finally"])?C():m(r,K)||"NEWLINE"===O?"else"===o?k():("TK_START_EXPR"!==_&&"="!==o||"function"!==r)&&("TK_WORD"!==_||"return"!==o&&"throw"!==o?"TK_END_EXPR"!==_?"TK_START_EXPR"===_&&"var"===r||":"===o||("if"===r&&"TK_WORD"===_&&"else"===h?k():C()):m(r,K)&&")"!==o&&C():k()):"SPACE"===O&&k(),D(),"var"===(h=r)&&(R=!(A=!0));break;case"TK_END_COMMAND":D(),A=!1;break;case"TK_STRING":"TK_START_BLOCK"===_||"TK_END_BLOCK"===_?C():"TK_WORD"===_&&k(),D();break;case"TK_OPERATOR":var w=!0,B=!0;if(A&&","!==r&&(R=!0,":"===r&&(A=!1)),":"===r&&E){D(),C();break}if(E=!1,","===r){A?R?(D(),C(),R=!1):(D(),k()):"TK_END_BLOCK"===_?(D(),C()):"BLOCK"===c?(D(),C()):(D(),k());break}"--"===r||"++"===r?B=";"===o?!(w=!0):w=!1:"!"===r&&"TK_START_EXPR"===_?B=w=!1:"TK_OPERATOR"===_?B=w=!1:"TK_END_EXPR"===_?B=w=!0:"."===r?B=w=!1:":"===r&&(w=!!o.match(/^\d+$/)),w&&k(),D(),B&&k();break;case"TK_BLOCK_COMMENT":C(),D(),C();break;case"TK_COMMENT":k(),D(),C();break;case"TK_UNKNOWN":D()}_=d,o=r}return s.join("")}function html_format2(){var t=$("#tool-form").val();if(""==t)return tips_error("请填写需要格式的HTML代码！"),$("#tool-form").focus(),!1;var e=$(".btn-success");e.attr("disabled","disabled"),tips_loading(),$.ajax({type:"post",dataType:"json",data:{str:t},url:WWW_URL+"ajax",success:function(t){1==t.status?(tips_clear(),$("#tool-result").show(),$("#tool-result").val(t.data)):($("#tool-result").hide(),tips_error(t.info)),e.removeAttr("disabled","disabled")}})}